# docker-openresty .travis.yml
#
# Builds docker-openresty images on Travis CI
#
# https://travis-ci.org/neomantra/docker-openresty
#
#
# Master will build with Docker tag:
#   openresty:<flavor>
#
# Releases should be tagged in git as:
#   <openresty-version>-<docker-version>
#
# This will build with Docker tags:
#   openresty:<openresty-version>-<docker-version>-<flavor>
#   openresty:<openresty-version>-<flavor>
#

os: linux
dist: bionic
language: ruby

services:
  - docker

jobs:
  include:
    - stage: build
      name: arm64/v8
      arch: arm64
      script:
      - docker build --build-arg RESTY_J=4 -t $DOCKER_USERNAME/openresty:alpine-arm64v8 -f alpine/Dockerfile .
      - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
      - docker push $DOCKER_USERNAME/openresty:alpine-arm64v8
      - docker build --build-arg RESTY_J=4 -t $DOCKER_USERNAME/openresty:alpine-fat-arm64v8 -f alpine/Dockerfile.fat .
      - docker push $DOCKER_USERNAME/openresty:alpine-fat-arm64v8
    - name: amd64
      arch: amd64
      script:
      - docker build --build-arg RESTY_J=4 -t $DOCKER_USERNAME/openresty:alpine-amd64 -f alpine/Dockerfile .
      - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
      - docker push $DOCKER_USERNAME/openresty:alpine-amd64
      - docker build --build-arg RESTY_J=4 -t $DOCKER_USERNAME/openresty:alpine-fat-amd64 -f alpine/Dockerfile.fat .
      - docker push $DOCKER_USERNAME/openresty:alpine-fat-amd64
    - stage: create manifest
      script:
      - docker manifest create \
        duncaan/openresty:alpine \
        --amend duncaan/openresty:alpine-amd64 \
        --amend duncaan/openresty:alpine-arm64v8
      - docker manifest push duncaan/openresty:alpine
      - docker manifest create \
        duncaan/openresty:alpine-fat \
        --amend duncaan/openresty:alpine-fat-amd64 \
        --amend duncaan/openresty:alpine-fat-arm64v8
      - docker manifest push duncaan/openresty:alpine-fat


