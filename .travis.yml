# docker-openresty .travis.yml
#
# Builds docker-openresty images on Travis CI
#
# https://travis-ci.org/neomantra/docker-openresty
#
#
# Master will build with Docker tag:
#   openresty:<flavor>
#
# Releases should be tagged in git as:
#   <openresty-version>-<docker-version>
#
# This will build with Docker tags:
#   openresty:<openresty-version>-<docker-version>-<flavor>
#   openresty:<openresty-version>-<flavor>
#

os: linux
dist: bionic
language: ruby

before_install:
  - curl -fsSL https://get.docker.com | sh
  - echo '{"experimental":"enabled"}' | sudo tee /etc/docker/daemon.json
  - mkdir -p $HOME/.docker
  - echo '{"experimental":"enabled"}' | sudo tee $HOME/.docker/config.json
  - sudo service docker start
  - sudo apt install -y qemu-user qemu-user-static
  #- docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

jobs:
  include:
    - name: build docker image for flavors alpine and alpine-fat
      script:
      - sudo docker buildx create --use
      - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
      - docker buildx build --progress plain --build-arg RESTY_J=4 --platform=linux/amd64,linux/arm64,linux/arm/v7 -t $DOCKER_USERNAME/openresty:alpine .
      - docker push $DOCKER_USERNAME/openresty:alpine
      - docker buildx build --progress plain --build-arg RESTY_J=4 --platform=linux/amd64,linux/arm64,linux/arm/v7 -t $DOCKER_USERNAME/openresty:alpine-fat .
      - docker push $DOCKER_USERNAME/openresty:alpine-fat

